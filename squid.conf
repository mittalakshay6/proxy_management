#acl localnet src 172.16.0.0/12	# RFC1918 possible internal network


acl SSL_ports port 443
acl Safe_ports port 80		# http
acl Safe_ports port 21		# ftp
acl Safe_ports port 443		# https
acl Safe_ports port 70		# gopher
acl Safe_ports port 210		# wais
acl Safe_ports port 1025-65535	# unregistered ports
acl Safe_ports port 280		# http-mgmt
acl Safe_ports port 488		# gss-http
acl Safe_ports port 591		# filemaker
acl Safe_ports port 777		# multiling http
acl CONNECT method CONNECT

# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

# Only allow cachemgr access from localhost
http_access allow localhost manager
http_access deny manager

# We strongly recommend the following be uncommented to protect innocent
# web applications running on the proxy server who think the only
# one who can access services on "localhost" is a local user
http_access deny to_localhost

#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#
#######################################################################################
#					BASIC CONFIGURATION			      #
#										      #
#######################################################################################
# block ip list
acl block_ip src 172.31.36.66 172.31.144.0/24  
http_access deny block_ip		

# allow without authentication and cache manager
acl allow_ip src 172.31.80.39 172.31.80.117 172.31.100.0/20 172.31.9.69
acl proxies src 172.31.102.29 172.31.100.25 172.31.100.14 172.31.100.29 172.31.103.29 172.31.102.14
http_access allow proxies
http_access allow allow_ip
http_access allow allow_ip manager		
http_access deny manager


dns_nameservers 172.31.100.6 8.8.8.8  

#sets up external authenticator which uses the passwd file to authenticate the users
auth_param basic program /usr/lib64/squid/basic_ncsa_auth /etc/squid/passwd  

# prompt while asking for the authentication
auth_param basic realm MNNIT PROXY    
acl authenticated proxy_auth REQUIRED   
http_access allow authenticated            

#spawns 10 children to handle authentication of users
auth_param basic children 10              
auth_param basic credentialsttl 2 hours   
auth_param basic casesensitive off
authenticate_cache_garbage_interval 1 hour
authenticate_ttl 1 hour
authenticate_ip_ttl 0 seconds


coredump_dir /cache/squid/swap 
            
# 190 GB cache with 64 first level dir and 512 second level dir     
cache_dir  aufs /cache/squid  190000 64 512

maximum_object_size 300 MB                 


visible_hostname  proxy214                     
unique_hostname proxy214                     



logformat accesslog  %ts.%03tu %6dt %6tr %>a %Ss/%03>Hs %<st %rm %ru %un %Sh/%<A %mt
access_log /logs/squid/access.log accesslog
cache_log /logs/squid/cache.log 
cache_store_log none

#access_log none
#cache_log /dev/null

#30 rotations allowed
logfile_rotate 30

#######################################################################################
#					BASIC CONFIGURATION			      #
#						ENDS				      #
#######################################################################################



###############################################################################
##STUFF RELATED TO CACHING AND PEERS NOW BEWARE
#########################################################################
icp_access allow all
icp_port 3130
cache_mgr webmaster
acl lan_dst dst 172.16.0.0/12
cache deny lan_dst				# denies caching of local web servers

acl QUERY urlpath_regex cgi-bin \?
cache deny QUERY			# denies caching of cgi content

always_direct allow lan_dst            # direct connection to lan servers

acl proxy014 src 172.31.100.14
acl proxy029 src 172.31.100.29
acl proxy026 src 172.31.100.26
acl proxy030 src 172.31.100.30
acl proxy214 src 172.31.102.14
acl proxy229 src 172.31.102.29
acl proxy329 src 172.31.103.29
acl proxy025 src 172.31.100.25
acl proxy027 src 172.31.100.27
##############################
#miss_access deny proxy
#miss_access allow all			#setting up so that cache miss is not fetched from here
####disabled for now above
#http access deny all
#cache_peer 172.31.100.14 parent 3128 0 no-query default  weight=25 login=edcguest:edcguest round-robin
cache_peer 172.31.102.29 sibling 3128 3130 proxy-only login=edcguest:edcguest 
#cache_peer 172.31.103.29 sibling 3128 0 proxy-only weight=30 login=edcguest:edcguest round-robin
#cache_peer 172.31.100.29 sibling 3128 0 proxy-only weight=10 login=edcguest:edcguest
#cache_peer 172.31.100.30 sibling 3128 0 proxy-only weight=8 login=edcguest:edcguest round-robin
#cache_peer 172.31.100.26 sibling 3128 0 proxy-only weight=6 login=edcguest:edcguest
#cache_peer 172.31.102.14 sibling 3128 0 proxy-only weight=2 login=edcguest:edcguest
cache_peer 172.31.100.25 sibling 3128 3130 proxy-only login=edcguest:edcguest



#never_direct allow all
#cache_peer_access 172.31.100.14 deny proxy014
#cache_peer_access 172.31.100.29 deny proxy029
#cache_peer_access 172.31.100.30 deny proxy030
cache_peer_access 172.31.102.29 deny proxy229
cache_peer_access 172.31.100.25 deny proxy025
#cache_peer_access 172.31.102.14 deny proxy214
#cache_peer_access 172.31.103.29 deny proxy329
#cache_peer_access 172.31.100.26 deny proxy026

#cache deny all





#######################################################################
#PEER ENDS
#######################################################################

# Example rule allowing access from your local networks.
# Adapt localnet in the ACL section to list your (internal) IP networks
# from where browsing should be allowed
http_access allow localnet
http_access allow localhost

# And finally deny all other access to this proxy
http_access deny all

# Squid normally listens to port 3128
http_port 172.31.102.14:3128

#
# Add any of your own refresh_pattern entries above these.
#
refresh_pattern ^ftp:		1440	20%	10080
refresh_pattern ^gopher:	1440	0%	1440
refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
refresh_pattern .		0	20%	4320